name: Compat Check

on:
  pull_request:
    branches: [ main ]
    paths:
      - 'workflows/**'
      - 'Dockerfile'
      - 'package-lock.json'
      - '.github/workflows/compat-check.yml'
  push:
    branches: [ main ]
    paths:
      - 'workflows/**'
      - 'Dockerfile'
      - '.github/workflows/compat-check.yml'

concurrency:
  group: compat-${{ github.ref }}
  cancel-in-progress: true

jobs:
  validate:
    name: Validate n8n workflows
    runs-on: ubuntu-24.04

    steps:
      - uses: actions/checkout@v4

      # En PR generamos N8N_ENCRYPTION_KEY temporal (no filtra secretos)
      - name: Make temp N8N_ENCRYPTION_KEY for PRs
        if: github.event_name == 'pull_request'
        run: echo "N8N_ENCRYPTION_KEY=$(openssl rand -hex 32)" >> "$GITHUB_ENV"

      # En push a main puedes reutilizar tu secret real si quieres (opcional)
      - name: Use repo secret key on push
        if: github.event_name == 'push'
        run: echo "N8N_ENCRYPTION_KEY=${{ secrets.N8N_ENCRYPTION_KEY }}" >> "$GITHUB_ENV"

      - name: Boot n8n (Docker)
        env:
          N8N_ENCRYPTION_KEY: ${{ env.N8N_ENCRYPTION_KEY }}
        run: |
          docker run -d --name n8n-ci \
            -p 5678:5678 \
            -e N8N_LISTEN_ADDRESS=0.0.0.0 \
            -e N8N_PORT=5678 \
            -e N8N_BASIC_AUTH_ACTIVE=false \
            -e GENERIC_TIMEZONE=Europe/Madrid \
            -e N8N_ENCRYPTION_KEY="$N8N_ENCRYPTION_KEY" \
            n8nio/n8n:1.111.1

          for i in {1..150}; do
            curl -fsS http://localhost:5678/ >/dev/null && { echo "âœ… n8n up"; break; }
            sleep 2
          done

      - name: Import workflows from repo
        run: |
          docker exec n8n-ci sh -lc 'mkdir -p /home/node/import'
          docker cp workflows/. n8n-ci:/home/node/import/ || true
          docker exec n8n-ci sh -lc 'shopt -s nullglob; FILES=(/home/node/import/*.json); \
            [ ${#FILES[@]} -eq 0 ] && echo "No hay workflows/*.json" || n8n import:workflow --input "/home/node/import/*.json"'

      - name: Cleanup
        if: always()
        run: |
          docker logs --tail 200 n8n-ci || true
          docker rm -f n8n-ci || true
