name: Validate n8n workflows

on:
  pull_request:
    branches: ["main"]
    paths:
      - "Dockerfile"
      - "workflows/**"
      - ".github/workflows/**"

jobs:
  validate:
    runs-on: ubuntu-latest
    env:
      IMAGE: n8nio/n8n:1.94.0
      CONTAINER: n8n-ci

    steps:
      - uses: actions/checkout@v4

      - name: Generar ENCRYPTION KEY efímera
        run: echo "N8N_ENCRYPTION_KEY=$(openssl rand -hex 32)" >> "$GITHUB_ENV"

      - name: Levantar n8n
        env:
          N8N_ENCRYPTION_KEY: ${{ env.N8N_ENCRYPTION_KEY }}
        run: |
          docker run -d --name $CONTAINER \
            -p 5678:5678 \
            -e N8N_LISTEN_ADDRESS=0.0.0.0 \
            -e N8N_PORT=5678 \
            -e N8N_BASIC_AUTH_ACTIVE=false \
            -e GENERIC_TIMEZONE=Europe/Madrid \
            -e N8N_ENCRYPTION_KEY="$N8N_ENCRYPTION_KEY" \
            -e N8N_ENFORCE_SETTINGS_FILE_PERMISSIONS=true \
            $IMAGE

          # Espera activa a healthz
          for i in $(seq 1 150); do
            if curl -fsS http://localhost:5678/healthz >/dev/null; then
              echo "✅ n8n up"
              break
            fi
            sleep 2
          done
          curl -fsS http://localhost:5678/healthz >/dev/null || (echo "❌ n8n no levantó a tiempo" && exit 1)

      - name: Importar workflows (POSIX sh, con glob correcto)
        run: |
          docker exec $CONTAINER sh -lc 'mkdir -p /home/node/import'
          
          if ls workflows/*.json >/dev/null 2>&1; then
          docker cp workflows/. $CONTAINER:/home/node/import/
          
          # Dentro del contenedor: forma robusta de comprobar expansión del glob
          docker exec $CONTAINER sh -lc '
           set -- /home/node/import/*.json
           if [ "$1" = "/home/node/import/*.json" ]; then
             echo "No hay workflows/*.json"
             exit 0
           fi
           # PASO CLAVE: no poner comillas al glob ni aquí ni pasar literal
           n8n import:workflow --input "$@"
          '
          else
          echo "ℹ️ No hay workflows/*.json en el repo; nada que importar"
          fi

      - name: Logs al fallar
        if: failure()
        run: docker logs --tail 500 $CONTAINER || true

      - name: Parar y limpiar
        if: always()
        run: docker rm -f $CONTAINER || true
