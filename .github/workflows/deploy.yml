name: Deploy n8n on Fly

on:
  push:
    branches: [ main ]
    tags: [ 'v*.*.*' ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      GENERIC_TIMEZONE: "Europe/Madrid"
      DB_TYPE: "postgres"
      FLY_DEPLOY_TOKEN: ${{ secrets.FLY_DEPLOY_TOKEN }}
      INTERVALS_ICU_ATHLETE_ID: ${{ secrets.INTERVALS_ICU_ATHLETE_ID }}
      INTERVALS_ICU_BASIC_AUTH: ${{ secrets.INTERVALS_ICU_BASIC_AUTH }}: ${{ secrets.INTERVALS_ICU_BASIC_AUTH }}
      N8N_BASIC_AUTH_USER: ${{ secrets.N8N_BASIC_AUTH_USER }}
      N8N_BASIC_AUTH_PASSWORD: ${{ secrets.N8N_BASIC_AUTH_PASSWORD }}
      N8N_ENCRYPTION_KEY: ${{ secrets.N8N_ENCRYPTION_KEY }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup Node.js & n8n CLI
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      - run: npm install -g n8n

            - name: Install jq
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Install Fly CLI
        run: |
          curl -L https://fly.io/install.sh | sh
          export FLYCTL_INSTALL="$HOME/.fly"
          export PATH="$FLYCTL_INSTALL/bin:$PATH"

      - name: Authenticate Fly
        run: |
          flyctl auth login --access-token ${{ secrets.FLY_DEPLOY_TOKEN }}

      - name: Deploy to Fly
        run: |
          flyctl deploy --config fly.toml

      - name: Import n8n workflows
        env:
          N8N_PROTOCOL: https
        run: |
          HOST=$(flyctl info --json | jq -r '.Hostname')
          n8n import:workflow --input=workflows/*.json --url "https://$HOST"
