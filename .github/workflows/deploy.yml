name: Deploy n8n to Fly.io

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  APP: running-coach-n8n

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Comprobar secrets requeridos
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
          N8N_ENCRYPTION_KEY: ${{ secrets.N8N_ENCRYPTION_KEY }}
        run: |
          if [ -z "${FLY_API_TOKEN:-}" ]; then
            echo "❌ Falta FLY_API_TOKEN"; exit 1
          fi
          if [ -z "${N8N_ENCRYPTION_KEY:-}" ]; then
            echo "❌ Falta N8N_ENCRYPTION_KEY"; exit 1
          fi
          echo "✅ Secrets presentes"

      - name: Setup flyctl
        uses: superfly/flyctl-actions/setup-flyctl@master

      # flyctl usa FLY_API_TOKEN del entorno automáticamente.
      - name: Verificar autenticación
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
        run: flyctl auth whoami

      - name: Actualizar secret N8N_ENCRYPTION_KEY en Fly
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
          N8N_ENCRYPTION_KEY: ${{ secrets.N8N_ENCRYPTION_KEY }}
        run: |
          flyctl secrets set N8N_ENCRYPTION_KEY="$N8N_ENCRYPTION_KEY" --app "$APP" --yes

      - name: Deploy a Fly
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
        run: |
          # Usa el fly.toml del repo. --remote-only construye en los builders de Fly.
          flyctl deploy --app "$APP" --remote-only --yes

      - name: Estado y últimas releases
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
        run: |
          flyctl status --app "$APP"
          flyctl releases --app "$APP" --limit 5
