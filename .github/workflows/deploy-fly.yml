# .github/workflows/deploy.yml
name: Deploy to Fly

on:
  push:
    branches: [ main ]
    paths:
      - 'workflows/**'
      - 'Dockerfile'
      - 'fly.toml'
      - '.github/workflows/deploy.yml'

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      APP: running-coach-n8n

    steps:
      - uses: actions/checkout@v4

      # Comprobación de secretos (solo para deploy)
      - name: Check secrets
        run: |
          [ -z "${FLY_API_TOKEN:-}" ] && { echo "❌ Falta FLY_API_TOKEN"; exit 1; }
          [ -z "${N8N_ENCRYPTION_KEY:-}" ] && { echo "❌ Falta N8N_ENCRYPTION_KEY"; exit 1; }
          echo "✅ Secrets presentes"
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
          N8N_ENCRYPTION_KEY: ${{ secrets.N8N_ENCRYPTION_KEY }}

      - uses: superfly/flyctl-actions/setup-flyctl@master
        with: { version: latest }

      - name: Whoami
        env: { FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }} }
        run: flyctl auth whoami

      # No uses --region en secrets y evita --yes (no existe). Usa --stage para no redeploy inmediato si quieres.
      - name: Set app secret (idempotente)
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
          N8N_ENCRYPTION_KEY: ${{ secrets.N8N_ENCRYPTION_KEY }}
        run: flyctl secrets set N8N_ENCRYPTION_KEY="$N8N_ENCRYPTION_KEY" --app "$APP" --stage

      - name: Deploy
        env: { FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }} }
        run: flyctl deploy --app "$APP" --remote-only
