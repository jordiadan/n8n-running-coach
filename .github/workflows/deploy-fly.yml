name: Deploy n8n to Fly (production)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

concurrency:
  group: deploy-fly
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      APP: running-coach-n8n        # <- Ajusta al nombre real de tu app en Fly
      REGION: fra
      FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
      N8N_ENCRYPTION_KEY: ${{ secrets.N8N_ENCRYPTION_KEY }}

    steps:
      - uses: actions/checkout@v4

      - name: Setup flyctl
        uses: superfly/flyctl-actions/setup-flyctl@master

      - name: Verifica secretos
        run: |
          [ -z "$FLY_API_TOKEN" ] && { echo "‚ùå Falta FLY_API_TOKEN"; exit 1; }
          [ -z "$N8N_ENCRYPTION_KEY" ] && { echo "‚ùå Falta N8N_ENCRYPTION_KEY"; exit 1; }

      - name: Asegura volumen y secreto en Fly
        run: |
          if ! flyctl volumes list -a "$APP" | grep -q 'n8n_data'; then
            flyctl volumes create n8n_data -a "$APP" --region "$REGION" --size 1
          fi
          if ! flyctl secrets list -a "$APP" | grep -q '^N8N_ENCRYPTION_KEY\b'; then
            flyctl secrets set N8N_ENCRYPTION_KEY="$N8N_ENCRYPTION_KEY" -a "$APP"
          fi

      - name: Deploy
        run: flyctl deploy -a "$APP" --config fly.toml

      - name: Espera health
        run: |
          for i in $(seq 1 60); do
            if flyctl checks list -a "$APP" | awk 'NR>1 {print $3}' | grep -q '^passing$'; then
              echo "‚úÖ health passing"; exit 0
            fi
            echo "‚è≥ esperando health... ($i)"; sleep 5
          done
          echo "‚ö†Ô∏è no pas√≥ health a√∫n"

      - name: Sube workflows del repo (si hay)
        run: |
          if ls workflows/*.json >/dev/null 2>&1; then
            flyctl ssh console -a "$APP" -C 'mkdir -p /home/node/import'
            for f in workflows/*.json; do
              echo "‚¨ÜÔ∏è $f"
              flyctl ssh sftp -a "$APP" -C "put $f /home/node/import/"
            done
          else
            echo "‚ÑπÔ∏è No hay workflows/*.json que subir"
          fi

      - name: Importa workflows en la instancia
        run: |
          # Todo via /bin/sh en remoto (sin bash ni shopt)
          flyctl ssh console -a "$APP" -C '
            set -- /home/node/import/*.json
            if [ -e "$1" ]; then
              echo "üõ¨ Importando en Fly..."
              n8n import:workflow --input "/home/node/import/*.json" && n8n list:workflow
            else
              echo "‚ÑπÔ∏è No hay nada que importar"
            fi
          '
