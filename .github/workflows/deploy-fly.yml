name: Deploy to Fly.io

on:
  workflow_run:
    workflows: ['CI']
    types: [completed]
  workflow_dispatch:

concurrency:
  group: fly-deploy-${{ github.ref }}
  cancel-in-progress: true

env:
  APP: running-coach-n8n

jobs:
  deploy:
    if: >
      (
        github.event_name == 'workflow_run' &&
        github.event.workflow_run.conclusion == 'success' &&
        github.event.workflow_run.event == 'push' &&
        github.event.workflow_run.head_branch == 'main'
      ) || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-24.04
    permissions:
      contents: read

    env:
      TARGET_REPO: ${{ github.event_name == 'workflow_run' && github.event.workflow_run.head_repository.full_name || github.repository }}
      TARGET_REF: ${{ github.event_name == 'workflow_run' && github.event.workflow_run.head_sha || github.sha }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          repository: ${{ env.TARGET_REPO }}
          ref: ${{ env.TARGET_REF }}
          fetch-depth: 1

      - name: Check required secrets
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
          N8N_ENCRYPTION_KEY: ${{ secrets.N8N_ENCRYPTION_KEY }}
          N8N_API_KEY: ${{ secrets.N8N_API_KEY }}
        run: |
          set -euo pipefail
          if [ -z "${FLY_API_TOKEN:-}" ]; then
            echo "❌ Missing FLY_API_TOKEN"; exit 1
          fi
          if [ -z "${N8N_ENCRYPTION_KEY:-}" ]; then
            echo "❌ Missing N8N_ENCRYPTION_KEY"; exit 1
          fi
          if [ -z "${N8N_API_KEY:-}" ]; then
            echo "❌ Missing N8N_API_KEY"; exit 1
          fi
          echo "✅ Required secrets present"

      - name: Setup flyctl
        uses: superfly/flyctl-actions/setup-flyctl@master
        with:
          version: latest

      - name: Auth check
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
        run: flyctl auth whoami

      - name: Stage N8N_ENCRYPTION_KEY on Fly
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
          N8N_ENCRYPTION_KEY: ${{ secrets.N8N_ENCRYPTION_KEY }}
        run: |
          flyctl secrets set N8N_ENCRYPTION_KEY="$N8N_ENCRYPTION_KEY" --app "$APP" --stage

      - name: Deploy to Fly
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
        run: |
          flyctl deploy --app "$APP" --config "fly.toml" --remote-only

      - name: Update workflow via n8n API
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
          N8N_API_KEY: ${{ secrets.N8N_API_KEY }}
        run: |
          set -euo pipefail
          api_url="https://${APP}.fly.dev/api/v1/workflows/Q9nTNHZ5vUBf58oI"
          echo "Updating workflow via API (app: $APP)"
          python3 - <<'PY'
          import json
          from pathlib import Path

          src = Path("workflows/running_coach_workflow.json")
          dst = Path("/tmp/n8n_workflow_update.json")

          allowed = {
              "name",
              "nodes",
              "connections",
              "settings",
          }

          data = json.loads(src.read_text())
          sanitized = {k: data[k] for k in allowed if k in data}
          dst.write_text(json.dumps(sanitized))
          PY
          for attempt in {1..10}; do
            status=$(curl -s -o /tmp/n8n_update_response.json -w "%{http_code}" \
              -X PUT \
              -H "X-N8N-API-KEY: $N8N_API_KEY" \
              -H "Content-Type: application/json" \
              --data-binary @/tmp/n8n_workflow_update.json \
              "$api_url" || true)
            if [ "$status" = "200" ]; then
              echo "✅ Workflow update succeeded"
              break
            fi
            echo "⏳ Update attempt $attempt failed (status: $status); retrying in 6s..."
            sleep 6
          done
          if [ "${status:-}" != "200" ]; then
            echo "❌ Workflow update failed after retries"
            cat /tmp/n8n_update_response.json || true
            exit 1
          fi
          echo "Verifying workflow payload matches repo"
          curl -s -o /tmp/n8n_workflow_remote.json \
            -H "X-N8N-API-KEY: $N8N_API_KEY" \
            "$api_url"
          python3 - <<'PY'
          import hashlib
          import json
          from pathlib import Path

          allowed = {"name", "nodes", "connections", "settings"}

          def canonical(obj):
              return json.dumps(obj, sort_keys=True, separators=(",", ":")).encode()

          local_path = Path("/tmp/n8n_workflow_update.json")
          remote_path = Path("/tmp/n8n_workflow_remote.json")

          local = json.loads(local_path.read_text())
          remote_raw = json.loads(remote_path.read_text())
          remote = {k: remote_raw[k] for k in allowed if k in remote_raw}

          local_hash = hashlib.sha256(canonical(local)).hexdigest()
          remote_hash = hashlib.sha256(canonical(remote)).hexdigest()

          if local_hash != remote_hash:
              print("❌ Workflow verification failed")
              print(f"local_hash={local_hash}")
              print(f"remote_hash={remote_hash}")
              raise SystemExit(1)

          print("✅ Workflow verification succeeded")
          PY
