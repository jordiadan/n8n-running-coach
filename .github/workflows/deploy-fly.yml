name: Deploy n8n to Fly (production)

on:
  push:
    branches: [ main ]           # <- SE DISPARA EN MERGE A MAIN
  workflow_dispatch:             # <- por si quieres dispararlo a mano

concurrency:
  group: deploy-fly
  cancel-in-progress: true

jobs:
  deploy:
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    env:
      APP: running-coach-n8n         # <-- Ajusta al nombre real de tu app en Fly
      REGION: fra
      FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
      N8N_ENCRYPTION_KEY: ${{ secrets.N8N_ENCRYPTION_KEY }}

    steps:
      - uses: actions/checkout@v4

      - name: Setup flyctl
        uses: superfly/flyctl-actions/setup-flyctl@master

      - name: Verifica secretos
        run: |
          [ -z "$FLY_API_TOKEN" ] && { echo "❌ Falta FLY_API_TOKEN"; exit 1; }
          [ -z "$N8N_ENCRYPTION_KEY" ] && { echo "❌ Falta N8N_ENCRYPTION_KEY"; exit 1; }

      - name: Asegura volumen y secreto
        run: |
          if ! flyctl volumes list -a "$APP" | grep -q 'n8n_data'; then
            flyctl volumes create n8n_data -a "$APP" --region "$REGION" --size 1
          fi
          if ! flyctl secrets list -a "$APP" | grep -q '^N8N_ENCRYPTION_KEY\b'; then
            flyctl secrets set N8N_ENCRYPTION_KEY="$N8N_ENCRYPTION_KEY" -a "$APP"
          fi

      - name: Deploy
        run: flyctl deploy -a "$APP" --config fly.toml

      - name: Espera health
        run: |
          for i in {1..60}; do
            if flyctl checks list -a "$APP" | awk 'NR>1 {print $3}' | grep -q '^passing$'; then
              echo "✅ health passing"; exit 0
            fi
            echo "⏳ esperando health... ($i)"; sleep 5
          done
          echo "⚠️ no pasó health, continúo igual"

      - name: Sube workflows del repo (si hay)
        run: |
          shopt -s nullglob
          WF=(workflows/*.json)
          if [ ${#WF[@]} -gt 0 ]; then
            flyctl ssh console -a "$APP" -C 'mkdir -p /home/node/import'
            for f in "${WF[@]}"; do
              echo "⬆️ $f"
              flyctl ssh sftp -a "$APP" -C "put $f /home/node/import/"
            done
          else
            echo "ℹ️ No hay workflows/*.json que subir"
          fi

      - name: Importa workflows en Fly
        run: |
          flyctl ssh console -a "$APP" -C 'shopt -s nullglob; FILES=(/home/node/import/*.json); \
            [ ${#FILES[@]} -eq 0 ] && echo "No hay nada que importar" || (n8n import:workflow --input "/home/node/import/*.json" && n8n list:workflow)'
